---
import Layout from '../layouts/Layout.astro';
import { sanityClient, fetchGlobalSettings } from "../lib/sanityClient";
import PageRenderer from "../components/PageRenderer.astro";

export async function getStaticPaths() {
    try {
        const pages = await sanityClient.fetch(`
            *[_type == "page" && slug.current != "inicio"] {
                slug,
                title,
                blocks[]{
                    'backgroundColor': coalesce(backgroundColor, 'none'),
                    'backgroundLayout': coalesce(backgroundLayout, 'grid'),
                    'contentLayout': coalesce(contentLayout, 'grid'),
                    _type,
                    ...,
                    _type == "blockSimpleHero" => {
                        title,
                        subtitle,
                        description,
                        cta{
                            text,
                            linkType,
                            url,
                            "internalPage": internalPage->{slug},
                            variant
                        },
                        backgroundImage{..., asset->{_ref, url}}
                    },
                    _type == "blockBlogHero" => {
                        title,
                        mainImage{..., asset->{_ref, url}},
                        publishedAt,
                        "author": author->{
                            name,
                            image{..., asset->{_ref, url}},
                            bio
                        },
                        "categories": categories[]->{
                            title,
                            description
                        }
                    },
                    _type == "blockHero" => {
                        mainTitle,
                        subtitle,
                        description,
                        primaryButton{
                            text,
                            linkType,
                            url,
                            "internalPage": internalPage->{slug},
                            variant
                        },
                        secondaryButton{
                            text,
                            linkType,
                            url,
                            "internalPage": internalPage->{slug},
                            variant
                        },
                        backgroundImage{..., asset->{_ref, url}},
                        silhouetteImage{..., asset->{_ref, url}},
                        silhouettePosition,
                        overlaySettings
                    },
                    _type == "serviceBlock" => {
                      "service": service->{
                        title,
                        duration,
                        price,
                        url,
                        weight,
                        shortDescription,
                        longDescription,
                        cardImage{..., asset->{_ref, url}},
                        blockImage{..., asset->{_ref, url}}
                      },
                      variant,
                      showPrice
                    },
                    _type == "serviceCarousel" => {
                      "items": items[]->{
                        title,
                        duration,
                        price,
                        url,
                        weight,
                        shortDescription,
                        longDescription,
                        cardImage{..., asset->{_ref, url}},
                        blockImage{..., asset->{_ref, url}}
                      } | order(coalesce(weight, 100) asc, title asc),
                      autoplay,
                      intervalMs,
                      showPrice
                    },
                    _type == "blockTestimonials" => {
                      "items": items[]{
                        image{..., asset->{_ref, url}, alt},
                        quote,
                        fullName
                      }
                    },
                    _type == "blockLogos" => {
                      title,
                      logos[]{..., asset->{_ref, url}, alt}
                    }
                }
            }
        `);

        return (pages as any[]).map((page: { slug: { current: string }, title: string, blocks: any[] }) => ({
            params: { slug: page.slug.current },
            props: { page }
        }));
    } catch (_err) {
        return [];
    }
}

interface CmsPage {
    title?: string;
    blocks?: any[];
}

const { page } = Astro.props as { page: CmsPage };

// Debug: verificar qué bloques se están recibiendo (comentado para producción)
// console.log('Page title:', page?.title);
// console.log('Page blocks:', page?.blocks?.map(block => ({ type: block._type, title: block.title || block.mainTitle })));
// console.log('Page blocks count:', page?.blocks?.length);
// console.log('SimpleHero blocks:', page?.blocks?.filter(block => block._type === 'blockSimpleHero'));

const settings = await fetchGlobalSettings();
---

<Layout 
  title={page?.title}
  globalSettings={settings}
>
  <PageRenderer blocks={page?.blocks} />
</Layout>