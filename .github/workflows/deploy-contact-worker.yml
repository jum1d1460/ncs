name: Deploy Contact Form Worker

# ğŸ¯ Solo se ejecuta cuando hay cambios en workers/contact-form/
on:
  push:
    branches:
      - main          # Deploy a production
      - develop       # Deploy a staging
    paths:
      - 'workers/contact-form/**'
      - '.github/workflows/deploy-contact-worker.yml'  # Si cambia el workflow
  
  # Permitir ejecuciÃ³n manual desde la UI de GitHub
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  # Job 1: Validar y testear
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: workers/contact-form/
      
      - name: ğŸ”§ Install dependencies
        working-directory: workers/contact-form
        run: npm ci
      
      - name: âœ… Lint check
        working-directory: workers/contact-form
        run: |
          # Agregar scripts de lint si existen
          echo "âœ“ Dependencies installed successfully"
      
      - name: ğŸ“Š Show package info
        working-directory: workers/contact-form
        run: |
          echo "Worker version:"
          node -p "require('./package.json').version"
          echo ""
          echo "Dependencies:"
          npm list --depth=0

  # Job 2: Deploy a staging (solo si push a develop)
  deploy-staging:
    name: Deploy to Staging
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://contact-form-worker-staging.your-account.workers.dev
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: workers/contact-form/
      
      - name: ğŸ”§ Install dependencies
        working-directory: workers/contact-form
        run: npm ci
      
      - name: ğŸš€ Deploy to Cloudflare (Staging)
        working-directory: workers/contact-form
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: npx wrangler deploy --env staging
      
      - name: ğŸ§ª Test deployed worker
        run: |
          echo "Testing staging deployment..."
          # Esperar 5 segundos para que el deploy se propague
          sleep 5
          
          # Test health endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" https://contact-form-worker-staging.your-account.workers.dev/health)
          
          if [ "$response" -eq 200 ]; then
            echo "âœ… Health check passed (HTTP $response)"
          else
            echo "âŒ Health check failed (HTTP $response)"
            exit 1
          fi
      
      - name: ğŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Contact Form Worker deployed to **staging**\n\nğŸ”— https://contact-form-worker-staging.your-account.workers.dev'
            })

  # Job 3: Deploy a production (solo si push a main)
  deploy-production:
    name: Deploy to Production
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://contact-form-worker.your-account.workers.dev
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: workers/contact-form/
      
      - name: ğŸ”§ Install dependencies
        working-directory: workers/contact-form
        run: npm ci
      
      - name: ğŸš€ Deploy to Cloudflare (Production)
        working-directory: workers/contact-form
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: npx wrangler deploy --env production
      
      - name: ğŸ§ª Test deployed worker
        run: |
          echo "Testing production deployment..."
          sleep 5
          
          response=$(curl -s -o /dev/null -w "%{http_code}" https://contact-form-worker.your-account.workers.dev/health)
          
          if [ "$response" -eq 200 ]; then
            echo "âœ… Health check passed (HTTP $response)"
          else
            echo "âŒ Health check failed (HTTP $response)"
            exit 1
          fi
      
      - name: ğŸ“ Create deployment annotation
        if: success()
        run: |
          echo "::notice title=Deployment Success::Contact Form Worker deployed to production successfully"
      
      - name: ğŸ”” Notify on failure
        if: failure()
        run: |
          echo "::error title=Deployment Failed::Contact Form Worker deployment to production failed"

  # Job 4: Notify en Slack/Discord (opcional)
  notify:
    name: Send Notification
    needs: [deploy-staging, deploy-production]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Deployment Status
        run: |
          echo "Deployment workflow completed"
          echo "Staging: ${{ needs.deploy-staging.result }}"
          echo "Production: ${{ needs.deploy-production.result }}"
      
      # Descomentar y configurar si quieres notificaciones en Slack
      # - name: ğŸ“¢ Slack Notification
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "Contact Form Worker deployed",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "ğŸš€ *Contact Form Worker Deployment*\n*Status:* ${{ job.status }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}"
      #             }
      #           }
      #         ]
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
