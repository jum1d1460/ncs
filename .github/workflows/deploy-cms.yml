name: Deploy CMS (Sanity Studio)

# ğŸ¯ Solo se ejecuta cuando hay cambios en cms/
on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'cms/**'
      - '.github/workflows/deploy-cms.yml'
  
  workflow_dispatch:

jobs:
  # Job 1: Build and validate
  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cms/package-lock.json
      
      - name: ğŸ”§ Install dependencies
        working-directory: cms
        run: npm ci
      
      - name: ğŸ§¹ Lint check
        working-directory: cms
        run: npm run lint --if-present
        continue-on-error: true
      
      - name: ğŸ§ª Run tests
        working-directory: cms
        run: npm test --if-present
        continue-on-error: true
      
      - name: ğŸ—ï¸ Build Sanity Studio
        working-directory: cms
        env:
          SANITY_AUTH_TOKEN: ${{ secrets.SANITY_AUTH_TOKEN }}
        run: npm run build
      
      - name: ğŸ“Š Build info
        working-directory: cms
        run: |
          echo "Build completed successfully"
          ls -lh dist/ || echo "No dist folder (expected for Sanity)"
      
      - name: ğŸ“¦ Upload build artifact
        if: hashFiles('cms/dist/**') != ''
        uses: actions/upload-artifact@v4
        with:
          name: cms-build
          path: cms/dist
          retention-days: 1

  # Job 2: Deploy to Sanity
  deploy:
    name: Deploy to Sanity
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cms/package-lock.json
      
      - name: ğŸ”§ Install dependencies
        working-directory: cms
        run: npm ci
      
      - name: ğŸ” Configure Sanity Auth
        working-directory: cms
        env:
          SANITY_AUTH_TOKEN: ${{ secrets.SANITY_AUTH_TOKEN }}
          SANITY_PROJECT_ID: ${{ secrets.SANITY_PROJECT_ID }}
          SANITY_DATASET: ${{ secrets.SANITY_DATASET }}
        run: |
          # Configurar el token de autenticaciÃ³n para Sanity
          echo "Configurando autenticaciÃ³n de Sanity..."
          npx sanity config set auth-token $SANITY_AUTH_TOKEN
      
      - name: ğŸš€ Deploy to Sanity
        working-directory: cms
        env:
          SANITY_AUTH_TOKEN: ${{ secrets.SANITY_AUTH_TOKEN }}
          SANITY_PROJECT_ID: ${{ secrets.SANITY_PROJECT_ID }}
          SANITY_DATASET: ${{ secrets.SANITY_DATASET }}
        run: npx sanity deploy
      
      - name: âœ… Deployment successful
        run: |
          echo "::notice title=Deployment Success::Sanity Studio deployed"
          echo "ğŸŒ Studio: https://ncs-psicologa.sanity.studio"
